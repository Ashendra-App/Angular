name: Deploy Angular to GitHub Pages

on:
  push:
    branches:
      - main   # change if your default branch is different

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'   # Angular CLI requires >= v20.19

      - name: Install dependencies (with retry)
        run: |
          RETRY=0
          until [ $RETRY -ge 3 ]
          do
            npm ci && break
            RETRY=$((RETRY+1))
            echo "npm ci failed — retry #$RETRY"
            sleep 3
          done
          if [ $RETRY -ge 3 ]; then
            echo "npm ci failed after 3 attempts"
            exit 1
          fi

      - name: Build Angular app
        run: npm run build -- --configuration=production

      - name: Detect outputPath from angular.json
        id: detect-output
        run: |
          OUTPUT=$(node -e '
            const path = require("path");
            const aj = require(path.resolve("angular.json"));
            const projects = Object.keys(aj.projects || {});
            if (!projects.length) { console.error("no projects in angular.json"); process.exit(2); }
            const proj = aj.defaultProject || projects[0];
            const out = aj.projects[proj]?.architect?.build?.options?.outputPath;
            if (!out) { console.error("outputPath not found for project " + proj); process.exit(3); }
            console.log(out);
          ')
          echo "output=$OUTPUT" >> $GITHUB_OUTPUT

      - name: Verify build output & deploy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BUILD_DIR="${{ steps.detect-output.outputs.output }}"
          echo "Detected build directory: $BUILD_DIR"
          if [ -z "$BUILD_DIR" ]; then
            echo "ERROR: outputPath detection failed."
            exit 1
          fi
          # show contents for debugging
          echo "Listing $BUILD_DIR:"
          ls -la "$BUILD_DIR" || true
          if [ ! -f "$BUILD_DIR/index.html" ]; then
            echo "❌ $BUILD_DIR/index.html not found! Build may have failed or outputPath is wrong."
            exit 1
          fi
          echo "Deploying from $BUILD_DIR to GitHub Pages..."
          npx angular-cli-ghpages --dir="$BUILD_DIR" --no-silent --message "Deploy from GitHub Actions"
