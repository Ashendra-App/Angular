name: Deploy Angular to GitHub Pages

on:
  push:
    branches:
      - main   # change if your default branch is different

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'   # Angular CLI requires >= v20.19

      - name: Install dependencies (with retry)
        run: |
          RETRY=0
          until [ $RETRY -ge 3 ]
          do
            npm ci && break
            RETRY=$((RETRY+1))
            echo "npm ci failed — retry #$RETRY"
            sleep 3
          done
          if [ $RETRY -ge 3 ]; then
            echo "npm ci failed after 3 attempts"
            exit 1
          fi

      - name: Build Angular app
        run: npm run build -- --configuration=production

      - name: Detect outputPath from angular.json
        id: detect-output
        run: |
          OUTPUT=$(node -e '
            const path = require("path");
            const aj = require(path.resolve("angular.json"));
            const projects = Object.keys(aj.projects || {});
            if (!projects.length) { console.error("no projects in angular.json"); process.exit(2); }
            const proj = aj.defaultProject || projects[0];
            const out = aj.projects[proj]?.architect?.build?.options?.outputPath;
            if (!out) { console.error("outputPath not found for project " + proj); process.exit(3); }
            console.log(out);
          ')
          echo "output=$OUTPUT" >> $GITHUB_OUTPUT

      - name: Verify build output & Deploy (find index.html anywhere)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BUILD_DIR="dist/ngxs"   # detected outputPath; leave as-is
          echo "Searching for index.html under: $BUILD_DIR"
          find "$BUILD_DIR" -maxdepth 6 -type f -name 'index.html' -print -quit > /tmp/found_index || true
          IDX=$(cat /tmp/found_index || true)
          if [ -z "$IDX" ]; then
            echo "❌ No index.html found under $BUILD_DIR (searched depth 6)."
            echo "Directory tree (files up to depth 3):"
            find "$BUILD_DIR" -maxdepth 3 -type f -printf '%P\n' || true
            exit 1
          fi
          TARGET_DIR=$(dirname "$IDX")
          echo "Found index.html at: $IDX"
          echo "Deploying directory: $TARGET_DIR"
          ls -la "$TARGET_DIR" || true
          npx angular-cli-ghpages --dir="$TARGET_DIR" --no-silent --message "Deploy from GitHub Actions"

